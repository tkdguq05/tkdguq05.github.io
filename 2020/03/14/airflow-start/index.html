<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Airflow Basic - Unreasonable Effectiveness</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Unreasonable Effectiveness"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Unreasonable Effectiveness"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Airflow의 기본적인 컨셉에 대해서 이해해보자"><meta property="og:type" content="article"><meta property="og:title" content="Airflow Basic"><meta property="og:url" content="http://tkdguq05.github.io/2020/03/14/airflow-start/"><meta property="og:site_name" content="Unreasonable Effectiveness"><meta property="og:description" content="Airflow의 기본적인 컨셉에 대해서 이해해보자"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://tkdguq05.github.io/images/airflow_logo.png"><meta property="article:published_time" content="2020-03-14T07:25:23.000Z"><meta property="article:modified_time" content="2020-03-16T00:53:32.000Z"><meta property="article:author" content="SangHyub Lee, Jose"><meta property="article:tag" content="airflow"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://tkdguq05.github.io/images/airflow_logo.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://tkdguq05.github.io/2020/03/14/airflow-start/"},"headline":"Airflow Basic","image":["http://tkdguq05.github.io/images/airflow_logo.png"],"datePublished":"2020-03-14T07:25:23.000Z","dateModified":"2020-03-16T00:53:32.000Z","author":{"@type":"Person","name":"SangHyub Lee, Jose"},"publisher":{"@type":"Organization","name":"Unreasonable Effectiveness","logo":{"@type":"ImageObject"}},"description":"Airflow의 기본적인 컨셉에 대해서 이해해보자"}</script><link rel="canonical" href="http://tkdguq05.github.io/2020/03/14/airflow-start/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Unreasonable Effectiveness</a></div><div class="navbar-menu"><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-03-14T07:25:23.000Z" title="2020. 3. 14. 오후 4:25:23">2020-03-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-03-16T00:53:32.000Z" title="2020. 3. 16. 오전 9:53:32">2020-03-16</time></span><span class="level-item"><a class="link-muted" href="/categories/engineering/">engineering</a></span></div></div><h1 class="title is-3 is-size-4-mobile">Airflow Basic</h1><div class="content"><p>Airflow의 기본적인 컨셉에 대해서 이해해보자</p>
<a id="more"></a>
<h1 id="Workflow-관리-Airflow-컨셉을-알아보자"><a href="#Workflow-관리-Airflow-컨셉을-알아보자" class="headerlink" title="Workflow 관리! Airflow 컨셉을 알아보자"></a>Workflow 관리! Airflow 컨셉을 알아보자</h1><p>요즘 왠만한 회사에서 Airflow를 안 쓰는 곳이 없습니다. 파이프라인 관련 세션을 들으면 심심치 않게 들을 수 있는 것이 Airflow를 이용한 워크플로우 관리일 것 입니다. 최근 저희 회사에서도 Airflow를 도입했습니다. 여러 세션에서 관련 내용을 기억해두고 정리해 두었다가, 잡 스케쥴을 관리할 필요성이 생겨서 Airflow 도입을 제안했습니다. 현재 Airflow를 이용해서 추천 쪽에 적용하고 있고, 대략 <code>전처리-모델링-Prediction</code>의 플로우를 돌리려고 합니다.  test를 계속해서 진행 중이고 시행착오법 끝에 DAG들이 잘 돌아가는 것을 확인하고 있습니다. </p>
<p>오늘 글은 간단하게 Airflow의 컨셉에 대해서 알아보는 내용입니다. 위에서도 등장한, Airflow의 핵심인 DAG에 대해서 알아보고, DAG안에 들어가는 요소들을 살펴보겠습니다.</p>
<h3 id="Workflow-Airflow"><a href="#Workflow-Airflow" class="headerlink" title="Workflow? Airflow?"></a>Workflow? Airflow?</h3><p>Airflow는 AirBnB에서 만든 Workflow 관리 툴입니다. workflow라고 하면, 대략적으로 ‘아 작업의 흐름’이라고 할 수 있겠습니다만, workflow를 조금 더 자세히 설명하자면 워크플로우는 작업 절차를 통한 정보 또는 업무의 이동을 의미하며, 더 자세히 말하면, 워크플로는 작업 절차의 운영적 측면이라고 할 수 있습니다.(출처 위키피디아) 여기서 업무라는 것이 등장합니다. Airflow에서 업무는 Task라고 합니다. 이 Task들이 연결 된 것이 Workflow고 이것을 관리하는 것이 Airflow입니다. 쉽게 말하자면, Airflow는 Task들을 잘 연결시키고 관리하는 툴이라고 볼 수 있겠습니다. Airflow를 활용하는 예는 다양합니다. 데이터 분야에서는 ETL 파이프라인에 사용해 데이터들을 관리할 수 있고, 모델의 학습주기를 관리할 수도 있습니다. 학습된 모델을 이용해 prediction해 배치성으로 결과들을 주기적으로 저장해 놓을 수도 있겠네요. 마케팅 도메인에서 활용한다면, 마케팅 자동화에 적용해서, 이메일을 자동으로 보내주는 일 등에도 활용할 수 있겠습니다. 어떤 작업이 성공했을때 다음 작업을 하게 한다거나(의존성, branching) 등의 작업도 가능하기 때문에 굉장히 다양하게 활용할 수 있습니다. </p>
<h3 id="DAG"><a href="#DAG" class="headerlink" title="DAG"></a>DAG</h3><p>방금 전까지 Airflow가 어떻게 흐르는지 알아봤습니다. 이 흐름은 어떻게 만들까요? Airflow에 대해서 찾아보면 다음과 같은 가지들을 볼 수 있습니다.<br><img src="/images/simple_dag.png" alt="깔끔한 DAG"></p>
<p>간단한 DAG라 보기 굉장히 편합니다. 하지만 DAG를 어떻게 짜느냐에 따라, 작업이 얼마나 복잡하냐에 따라 DAG는 복잡하게 변할 수 있습니다.<br><img src="/images/complex_dag.png" alt="흉악한 DAG"><br>그래도 이렇게 눈으로 보고 확인할 수 있으니 얼마나 편한지 모르겠습니다. 이걸 airflow없이 코드로 일일이 보고 작업 스케쥴 관리를 하려면 몸과 마음이 지쳐 월요일부터 글또 채널에 pass권을 사용할지도 모릅니다.</p>
<p>다행히도, 우리에겐 Airflow가 있고 Task들을 DAG를 통해서 이어주면 한 눈에 알아볼 수 있습니다. DAG는 Directed Acyclic Graph의 약자입니다. 번역하자면, ‘방향성 비순환 그래프’입니다. 노드와 노드가 단방향으로 연결되고 한번 노드로 향하면, 돌아오지 않는 특성을 가진다는 정도만 알면 될 것 같습니다. </p>
<p>DAG는 Python script로 작성되어 있습니다. 따라서 python에 익숙한 분들이라면 DAG작성은 별로 어렵지 않을 것입니다. DAG를 구성하는 요소들에 대한 개념만 알면 쉽게 쉽게 짤 수 있습니다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta, datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.slack_alert <span class="keyword">import</span> SlackAlert</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> airflow <span class="keyword">import</span> DAG</span><br><span class="line"><span class="keyword">from</span> airflow.models <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">from</span> airflow.contrib.operators.bigquery_operator <span class="keyword">import</span> BigQueryOperator</span><br><span class="line"><span class="keyword">from</span> airflow.contrib.operators.bigquery_check_operator <span class="keyword">import</span> BigQueryCheckOperator</span><br><span class="line"></span><br><span class="line">alert = SlackAlert(<span class="string">'#test'</span>)</span><br><span class="line"><span class="comment"># Config variables</span></span><br><span class="line">dag_config = Variable.get(<span class="string">"bigquery_github_trends_variables"</span>, deserialize_json=<span class="keyword">True</span>)</span><br><span class="line">BQ_CONN_ID = dag_config[<span class="string">"bq_conn_id"</span>]</span><br><span class="line">BQ_PROJECT = dag_config[<span class="string">"bq_project"</span>]</span><br><span class="line">BQ_DATASET = dag_config[<span class="string">"bq_dataset"</span>]</span><br><span class="line"></span><br><span class="line">default_args = &#123;</span><br><span class="line">    <span class="string">'owner'</span>: <span class="string">'Jose Lee'</span>,</span><br><span class="line">    <span class="string">'depends_on_past'</span>: <span class="keyword">True</span>,    </span><br><span class="line">    <span class="string">'start_date'</span>: datetime(<span class="number">2018</span>, <span class="number">12</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="string">'end_date'</span>: datetime(<span class="number">2018</span>, <span class="number">12</span>, <span class="number">5</span>),</span><br><span class="line">    <span class="string">'email_on_failure'</span>: <span class="keyword">True</span>,</span><br><span class="line">    <span class="string">'email_on_retry'</span>: <span class="keyword">False</span>,</span><br><span class="line">    <span class="string">'retries'</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">'retry_delay'</span>: timedelta(minutes=<span class="number">5</span>),</span><br><span class="line">    <span class="string">'on_failure_callback'</span> : alert.slack_fail_alert</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set Schedule: Run pipeline once a day. </span></span><br><span class="line"><span class="comment"># Use cron to define exact time. Eg. 8:15am would be "15 08 * * *"</span></span><br><span class="line">schedule_interval = <span class="string">"00 21 * * *"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define DAG: Set ID and assign default args and schedule interval</span></span><br><span class="line">dag = DAG(</span><br><span class="line">    <span class="string">'bigquery_github_trends'</span>, </span><br><span class="line">    default_args=default_args, </span><br><span class="line">    schedule_interval=<span class="string">'@once'</span></span><br><span class="line">    <span class="comment"># schedule_interval</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Config variables</span></span><br><span class="line">BQ_CONN_ID = <span class="string">'my_gcp_conn'</span></span><br><span class="line"><span class="comment"># BQ_PROJECT = 'airflow-268501'</span></span><br><span class="line"><span class="comment"># BQ_DATASET = 'github_trends'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Task 1: check that the github archive data has a dated table created for that date</span></span><br><span class="line">t1 = BigQueryCheckOperator(</span><br><span class="line">        task_id=<span class="string">'bq_check_githubarchive_day'</span>,</span><br><span class="line">        sql=<span class="string">'''</span></span><br><span class="line"><span class="string">        #standardSQL</span></span><br><span class="line"><span class="string">        SELECT</span></span><br><span class="line"><span class="string">          table_id</span></span><br><span class="line"><span class="string">        FROM</span></span><br><span class="line"><span class="string">          `githubarchive.day.__TABLES_SUMMARY__`</span></span><br><span class="line"><span class="string">        WHERE</span></span><br><span class="line"><span class="string">          table_id = "&#123;&#123; yesterday_ds_nodash &#125;&#125;"</span></span><br><span class="line"><span class="string">        '''</span>,</span><br><span class="line">        use_legacy_sql=<span class="keyword">False</span>,</span><br><span class="line">        bigquery_conn_id=BQ_CONN_ID,</span><br><span class="line">        dag=dag</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>제가 연습하느라 사용했던 DAG를 보면서 설명해보겠습니다. import를 뭘하는지 보면 방금까지 설명한 DAG, 그리고 Variable과 operator가 보입니다. </p>
<h3 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h3><p>Variable은 Airflow UI를 보면서 설명을 해야 할 것 같습니다.  UI에 Variable의 탭이 별도로 존재하기 때문입니다.<br><img src="/images/airflow_variable.png" alt="Airflow의 Variable탭"></p>
<p>위의 화면이 Variable을 보여주고 있습니다. Key와 Value로 이루어진 걸 알 수 있습니다. Key Value로 이루어진 데이터를 이용하고 싶다면, Variable에 등록해두면 편하게 dict로 값을 받듯이 <code>Variable.get</code>를 이용해서 값을 얻을 수 있습니다. 위의 예시에서는 <code>dag_config = Variable.get(&quot;bigquery_github_trends_variables&quot;, deserialize_json=True)</code><br><code>BQ_CONN_ID = dag_config[&quot;bq_conn_id&quot;]</code>이 부분이 되겠습니다. 저희 회사의 경우에는 각 고객사의 서비스키와 캠페인키를 Variable에 넣어두고 사용하고 있습니다. 신규 고객사가 발생하면 코드를 일일이 만들 필요없이 간단하게 Variable에 넣어두고 DAG를 태우면 끝입니다! </p>
<h3 id="default-args"><a href="#default-args" class="headerlink" title="default_args"></a>default_args</h3><p>default_args는 dictionary로 이루어져 있고 DAG에 들어가게 됩니다. 여기에 작성한 내용들이 operator들에 적용될 것입니다. 일일이 operator에 넣을 필요없이 default_args에 넣어서 수정하면 되니까 굉장히 간편하게 여러 오퍼레이터에 들어갈 파라미터들을 관리 할 수 있습니다.</p>
<h3 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h3><p>DAG가 워크 플로우를 어떻게 run할지를 설명한다면, Operator는 실제 Task가 수행하는 작업을 결정합니다. 실제 Task가 돌아가는 것을 Operator를 통해서 지정해준다고 보면 됩니다. operator의 종류는 굉장히 다양합니다. 대표적으로는</p>
<ul>
<li>BashOperator : bash 커맨드를 실행시킨다</li>
<li>PythonOperator : python 함수를 호출한다</li>
<li>EmailOperator : 이메일을 보낸다</li>
<li>SimpleHttpOperator : HTTP 요청을 보낸다<br>이런 것들이 있습니다. 위의 코드에서는 BigQueryCheckOperator를 사용했습니다. Bigquery에 접근해서 쿼리를 보내고 싶었기 때문입니다. Google Cloud Platform에 지원되는 다양한 Operator들이 있고, 저희 회사는 AWS를 주로 사용하기 때문에 AWS operator를 많이 사용하고 있습니다. 추가로 SlackAPIOperator 등도 있으니 아이디어만 있다면 왠만한 작업은 다 처리가 가능할 것 입니다.</li>
</ul>
<p>슬랙 이야기가 나와서 덧붙이자면,  default_args에 보면 <code>&#39;on_failure_callback&#39; : alert.slack_fail_alert</code>이 있습니다. 대략 유추가 가능하겠지만, 실패시에 슬랙에 알럿을 띄우려고 만들어 둔 파라미터 입니다. Airflow 작업을 하다가 실패가 나면 슬랙을 통해서 알럿을 보고 대응하기 위해서 작성해 두었습니다. 슬랙에 알람을 보내는 내용은 다음 글에서 다뤄보도록 하겠습니다.</p>
<p>이렇게 간단한 DAG가 만들어지고 airflow_home에 있는 dag폴더에 업로드가 되면 airflow UI에서 DAG가 떠있는 것을 확인할 수 있습니다.<br>(Airflow UI<a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8080</a>)<br><img src="/images/airflow_main.png" alt="내가 만든 DAG"><br><img src="/images/airflow_task.png" alt="DAG로 들어가면 Task들의 상태를 확인할 수 있다"></p>
<p>Task들의 상태는 다음과 같이 나눠집니다.<br><img src="/images/task_stages.png" alt="Task들의 상태들"></p>
<p>이제 이 상태들을 확인해 보면서 워크플로우를 관리해 나가면 됩니다. </p>
<hr>
<p>이번 글에서는 Airflow의 정말 기본적인 개념들에 대해서 다뤄봤습니다. 간단한 DAG를 직접 작성해보고 success를 한번 띄워보면 Airflow가 어떤 건지 대략적인 감을 잡을 수 있을 것 이라고 생각합니다. 다음 글에서는 슬랙을 통해서 메세지 알람을 보내는 걸 작성해 보려고 합니다. 저도 공부를 하는 입장이라 부족한 내용일 수 있지만, 보시면서 틀린 부분이나 수정할 부분 알려주시면 감사하겠습니다. </p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/airflow/">airflow</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/03/29/craft/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">CRAFT 요약 Character Region Awarenness for Text Detection)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/02/24/geultto4/"><span class="level-item">글또 4기를 시작하며 다짐하기</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-3-tablet is-3-desktop is-3-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Workflow-관리-Airflow-컨셉을-알아보자"><span class="level-left"><span class="level-item">1</span><span class="level-item">Workflow 관리! Airflow 컨셉을 알아보자</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Operator"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">Operator</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Unreasonable Effectiveness</a><p class="is-size-7"><span>&copy; 2023 SangHyub Lee, Jose</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>